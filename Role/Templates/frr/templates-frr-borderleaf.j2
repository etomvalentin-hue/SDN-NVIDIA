#Fichier Template: templates/frr/borderleaf.j2

! Border Leaf FRR Configuration - {{ hostname }}
log syslog informational

route-map UNDERLAY_LO permit 10
  match interface lo

route-map INTERNET-CON permit 10
  match interface {{ router_interface[0].name }}

vrf {{ evpn_vrf.name }}
        vni {{ evpn_vrf.l3vni }}
        exit-vrf

vrf {{ internet_vrf.name }}
        exit-vrf

router bgp {{ bgp_asn }}
  bgp router-id {{ router_id }}
  timers bgp {{ bgp_timers }}
  no bgp default ipv4 unicast
  bgp log-neighbor-changes

  neighbor {{ peer_group_names.underlay }} peer-group
  neighbor {{ peer_group_names.underlay }} advertisement-interval {{ bgp_advertisement_interval }}
  neighbor {{ peer_group_names.underlay }} remote-as external
  neighbor {{ peer_group_names.underlay }} capability extended-nexthop
  
  {% for intf in spine_interfaces %}
  neighbor {{ intf.name }} interface peer-group {{ peer_group_names.underlay }}
  {% endfor %}

  {% for fw_intf in firewall_interfaces if fw_intf.vrf == "default" %}
  neighbor {{ fw_intf.name }} interface remote-as external
  {% endfor %}

  bgp bestpath as-path multipath-relax

  address-family ipv4 unicast
    neighbor {{ peer_group_names.underlay }} activate
    {% for fw_intf in firewall_interfaces if fw_intf.vrf == "default" %}
    neighbor {{ fw_intf.name }} activate
    neighbor {{ fw_intf.name }} allowas-in 1
    {% endfor %}
    redistribute connected route-map UNDERLAY_LO
  exit-address-family

  address-family l2vpn evpn
    advertise-all-vni
    neighbor {{ peer_group_names.underlay }} activate
    advertise ipv4 unicast
  exit-address-family

! EVPN VRF
router bgp {{ bgp_asn }} vrf {{ evpn_vrf.name }}
    bgp router-id {{ router_id }}
    timers bgp {{ bgp_timers }}
    no bgp default ipv4 unicast
    bgp log-neighbor-changes
    bgp bestpath as-path multipath-relax

    {% for fw_intf in firewall_interfaces if fw_intf.vrf == evpn_vrf.name %}
    neighbor {{ fw_intf.name }} remote-as {{ external_peers.firewall.asn }}
    {% endfor %}

    address-family ipv4 unicast
        {% for fw_intf in firewall_interfaces if fw_intf.vrf == evpn_vrf.name %}
        neighbor {{ fw_intf.name }} activate
        neighbor {{ fw_intf.name }} allowas-in 1
        {% endfor %}
        {% for aggregate in evpn_aggregates %}
        aggregate-address {{ aggregate }} summary-only
        {% endfor %}
    exit-address-family

    address-family l2vpn evpn
        advertise ipv4 unicast
    exit-address-family

! Internet VRF
router bgp {{ bgp_asn }} vrf {{ internet_vrf.name }}
    bgp router-id {{ router_id }}
    timers bgp {{ bgp_timers }}
    no bgp default ipv4 unicast
    bgp log-neighbor-changes
    bgp bestpath as-path multipath-relax

    neighbor {{ peer_group_names.internet }} peer-group
    neighbor {{ peer_group_names.internet }} remote-as external

    {% for router_intf in router_interface %}
    neighbor {{ router_intf.name }} interface peer-group {{ peer_group_names.internet }}
    {% endfor %}

    {% for fw_intf in firewall_interfaces if fw_intf.vrf == internet_vrf.name %}
    neighbor {{ fw_intf.name }} interface peer-group {{ peer_group_names.internet }}
    {% endfor %}

    address-family ipv4 unicast
        neighbor {{ peer_group_names.internet }} activate
        {% for fw_intf in firewall_interfaces if fw_intf.vrf == internet_vrf.name %}
        neighbor {{ fw_intf.name }} allowas-in 1
        {% endfor %}
        {% for router_intf in router_interface %}
        neighbor {{ router_intf.name }} remove-private-as
        {% endfor %}
        redistribute connected route-map INTERNET-CON
    exit-address-family